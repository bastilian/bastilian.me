---
image: dokku/ci-docker-image

stages:
  - deploy
  - release

variables:
  GIT_DEPTH: 0

dokku-deploy:
  stage: deploy
  only:
    - main
  variables:
    GIT_REMOTE_URL: ssh://dokku@dokku.ams.bastilian.me:22/bastilian-me-deno
    GIT_PUSH_FLAGS: --force
  script:
    - dokku-deploy

deno-deploy:
    image:
      name: denoland/deno:1.46.3
    stage: deploy
    only:
      - main
    script:
      - bash && deno install --global -Arf jsr:@deno/deployctl
      - bash && deno task build
      - bash && deployctl deploy --prod --project=bastilian-me main.ts

release_job:
    stage: release
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    rules:
      - if: $CI_COMMIT_TAG
        when: never
      - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    script:
      - echo "running release_job for $TAG"
    release:
      tag_name: 'v0.$CI_PIPELINE_IID-$TAG'
      description: 'v0.$CI_PIPELINE_IID-$TAG'
      ref: '$CI_COMMIT_SHA'
